---
title: "Blossom Watch 2021"
author: "Alan Millington"
date: "`r Sys.time()`"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# ## install remotes package if it's not already
# if (!requireNamespace("remotes", quietly = TRUE)) {
#   install.packages("remotes")
# }

## install dev version of rtweet from github
#remotes::install_github("ropensci/rtweet")

## load rtweet package
library(rtweet)
library(tidyverse)
library(lubridate)
library(knitr)
library(pander)
library(wordcloud)
library(tidytext)
library(igraph)
library(httpuv)

theme_set(theme_light())
```

```{r search-twitter, eval=FALSE, echo=FALSE}
## store api keys (these are fake example values; replace with your own keys)
#api_key <- Sys.getenv('TwitterAPIkey')
#api_secret_key <- Sys.getenv('TwitterAPIsecretkey')

# ## authenticate via web browser
# token <- create_token(
#   app = "rtwitterscraper_alanmillington",
#   consumer_key = api_key,
#   consumer_secret = api_secret_key, 
#   set_renv = FALSE)
```

```{r}
blossom2021 <- search_tweets("#blossom OR #blossomwatch OR #NationalTrust OR #EveryoneNeedsNature", n = 50000, lang = "en", retryonratelimit = FALSE)
```

```{r count-hashtags}
hashtag_count <- tibble(hashtag = c("blossom", "blossomwatch", "NationalTrust + BlossomWatch", "EveryoneNeedsNature", "None"),
                        count = c(blossom2021 %>% 
                                    filter(grepl("blossom", hashtags, ignore.case = TRUE)) %>%
                                    filter(!grepl("blossomwatch", hashtags, ignore.case = TRUE)) %>%
                                    nrow(),
                                  blossom2021 %>% 
                                    filter(grepl("blossomwatch", hashtags, ignore.case = TRUE)) %>%
                                    nrow(),
                                  blossom2021 %>% 
                                    filter(grepl("NationalTrust", hashtags, ignore.case = TRUE)) %>%
                                    filter(grepl("blossomwatch", hashtags, ignore.case = TRUE)) %>%
                                    nrow(),
                                  blossom2021 %>% 
                                    filter(grepl("EveryoneNeedsNature", hashtags, ignore.case = TRUE)) %>%
                                    nrow(),
                                  blossom2021 %>% 
                                    filter(!grepl("blossom", hashtags, ignore.case = TRUE)) %>%
                                    filter(!grepl("blossomwatch", hashtags, ignore.case = TRUE)) %>%
                                    filter(!grepl("NationalTrust", hashtags, ignore.case = TRUE)) %>%
                                    filter(!grepl("EveryoneNeedsNature", hashtags, ignore.case = TRUE)) %>%
                                    nrow()))

hashtag_count %>%
  pander(justify = c("left", "right"))
```

# Timeline
## Tweets by day
```{r tweets-by-day}
blossom2021 %>% 
  mutate(date = as_date(created_at, tz = "Europe/London")) %>% 
  count(date) %>% 
  ggplot(aes(date, n)) + geom_col(fill = "skyblue3") +  
    labs(x = "Date", y = "Tweets", title = "#blossom tweets per day") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Tweets by day and time
Filtered for dates March, London time.
```{r tweets-by-day-hour}
blossom2021 %>% 
  mutate(datetime = as_datetime(created_at, tz = "Europe/London"), hour = hour(datetime)) %>%
  group_by(date = as_date(datetime), hour) %>% 
  summarise(count = n()) %>% 
  filter(date >= as_date("2021-03-11"), date <= Sys.Date()) %>%
  ggplot(aes(hour, count)) + geom_col(fill = "skyblue3") + facet_grid(strftime(date, "%b %d") ~ .) + 
    labs(x = "Hour", y = "Tweets", title = "#blossom tweets by time of day") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 15))
```


# Users
## Top tweeters
```{r tweets-top-users}
blossom2021 %>% 
  count(screen_name) %>% 
  filter(n >= 8) %>% 
  ggplot(aes(reorder(screen_name, n), n)) + geom_col(fill = "skyblue3") + coord_flip() + 
    labs(x = "Screen Name", y = "Tweets", title = "#blossom tweets by user", subtitle = "users with >= 8 tweets") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Sources
```{r tweets-top-sources}
blossom2021 %>% 
distinct(screen_name, source) %>%
  count(source) %>% 
  filter(n >= 5) %>%
  ggplot(aes(reorder(source, n), n)) + geom_col(fill = "skyblue3") + coord_flip() + 
    labs(x = "Source", y = "Tweets", title = "#blossom tweets by source", subtitle = "sources with >= 5 tweets") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```



# Networks
## Replies
The "replies network", composed from users who reply directly to one another.

Better to view the original PNG file in the `data` directory.


```{r reply-network, eval=FALSE}
blossom2021_replies <- blossom2021 %>% 
  filter(!is.na(reply_to_screen_name)) %>% 
  select(screen_name, reply_to_screen_name) %>% 
  graph.data.frame(directed = TRUE)

V(blossom2021_replies)$label <- V(blossom2021_replies)$name
V(blossom2021_replies)$id    <- V(blossom2021_replies)$name

write_graph(blossom2021_replies, file = "blossom2021_replies.graphml", format = "graphml")
```


![](replies_network.png)


## Mentions
The "mentions network", where users mention other users in their tweets.

Better to view the original PNG file in the `data` directory.

```{r mentions-network, eval=FALSE}
blossom_mentions <- blossom2021 %>% 
  mutate(mentions_screen_name = sapply(mentions_screen_name, 
                           function(x) paste(x, collapse = " "))) %>%
  select(screen_name, mentions_screen_name) %>% 
  mutate(mentions_screen_name = strsplit(mentions_screen_name, " ")) %>% 
  unnest(mentions_screen_name) %>% 
  filter(mentions_screen_name != "NA") %>% 
  graph.data.frame()

V(blossom_mentions)$label <- V(blossom_mentions)$name
V(blossom_mentions)$id    <- V(blossom_mentions)$name

write_graph(blossom_mentions, file = "blossom_mentions.graphml", format = "graphml")

```


![](mentions_network.png)



# Retweets
## Retweet proportion
```{r is-retweet}
blossom2021 %>% 
  count(is_retweet) %>% 
  ggplot(aes(is_retweet, n)) + geom_col(fill = "skyblue3") + 
    labs(x = "Is retweet", y = "Tweets", title = "#blossom tweets by retweet status") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Retweet count
```{r retweet-count}
blossom2021 %>% 
  ggplot(aes(retweet_count)) + geom_histogram(bins = max(blossom2021$retweet_count), fill = "skyblue3") +
    labs(x = "Retweet count", y = "Tweets", title = "#blossom distribution of retweets per tweet") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Top retweets
```{r most-retweeted}
blossom2021 %>% 
  filter(screen_name != 'missmayim') %>%
  filter(is.na(retweet_status_id)) %>% 
  select(screen_name, text, retweet_count) %>% 
  arrange(desc(retweet_count)) %>% 
  distinct() %>%
  slice(1:10) %>% 
  pander(justify = c("left", "left", "right"), split.table = Inf)
```

# Favourites

## Favourite proportion
```{r has-favorite}
blossom2021 %>% 
  mutate(has_favorite = ifelse(favorite_count > 0, TRUE, FALSE)) %>% 
  count(has_favorite) %>%
  ggplot(aes(has_favorite, n)) + geom_col(fill = "skyblue3") + 
    labs(x = "Has favorite", y = "Tweets", title = "#blossom tweets by favorited status") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Favourite count
```{r favorite-count}
blossom2021 %>% 
  ggplot(aes(favorite_count)) + geom_histogram(bins = max(blossom2021$favorite_count), fill = "skyblue3") +
    labs(x = "Favorite count", y = "Tweets", title = "#blossom distribution of favorites per tweet") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Top favourites
```{r most-favorited}
blossom2021 %>% 
  filter(screen_name != 'missmayim') %>%
  select(screen_name, text, favorite_count) %>% 
  arrange(desc(favorite_count)) %>% 
  distinct() %>%
  slice(1:10) %>% 
  pander(justify = c("left", "left", "right"), split.table = Inf)
```

# Quotes

## Quote proportion
```{r is-quote}
blossom2021 %>% 
  count(is_quote) %>% 
  ggplot(aes(is_quote, n)) + geom_col(fill = "skyblue3") + 
    labs(x = "Is quote", y = "Tweets", title = "#blossom tweets by quote status") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Quote count
```{r quotes-count}
blossom2021 %>% 
  filter(!is.na(quoted_status_id)) %>% 
  count(quoted_status_id) %>% 
  ggplot(aes(n)) + geom_histogram(bins = 10, fill = "skyblue3") +
    labs(x = "Quote count", y = "Tweets", title = "#blossom distribution of quotes per tweet") + 
    scale_x_continuous(limits = c(0, 10), breaks = seq(0, 10, 2)) + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Top quotes
```{r most-quoted}
blossom2021 %>% 
  filter(!is.na(quoted_status_id)) %>% 
  count(quoted_status_id) %>% 
  filter(n > 1) %>% 
  arrange(desc(n)) %>% 
  slice(1:10) %>% 
  inner_join(select(blossom2021, screen_name, quoted_status_id, is_retweet, text)) %>% 
  filter(is_retweet == FALSE) %>% 
  select(screen_name, text, quote_count = n) %>%
  distinct() %>%
  slice(1:10) %>%
  pander(justify = c("left", "left", "right"), split.table = Inf)
```


# Media

## Media count
```{r has-media}
blossom2021 %>% 
  mutate(has_media = !is.na(media_url)) %>% 
  count(has_media) %>% 
  ggplot(aes(has_media, n)) + geom_col(fill = "skyblue3") + 
    labs(x = "Has media", y = "Tweets", title = "#blossom tweets by media status") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Top media
```{r liked-media}
blossom_media <- blossom2021 %>%
  filter(screen_name != 'missmayim') %>%
  filter(!is.na(media_url)) %>% 
  arrange(desc(favorite_count)) %>%
  filter(favorite_count > 0)

blossom_media %>%
  slice(1:10) %>% 
  select(screen_name, text, favorite_count) %>%
  pander(justify = c("left", "left", "right"), split.table = Inf)
```

### Most liked media image

![](`r blossom_media[1, "media_url"]`)

# Tweet text
The 100 words used 3 or more times.

```{r count-words}
data("stop_words")

blossom2021 %>% 
  filter(is_retweet == FALSE) %>%
  select(text) %>%
  unnest_tokens(word, text) %>% 
  select(word) %>% 
  filter(!word %in% c("blossom", "blossomwatch", "nationaltrust", "everyoneneedsnature", "https", "t.co", "amp"),
         !word %in% tolower(blossom2021$screen_name), 
         !grepl("^\\d+$", word)) %>% 
  anti_join(stop_words) %>% 
  count(word) %>% 
  with(wordcloud(word, n, max.words = 100, min.freq = 3, colors = brewer.pal(8, "Accent")))
```

## Who has 280 characters?
```{r count-tweet-length}
blossom2021 %>% 
  mutate(chars = nchar(text)) %>% 
  count(chars) %>% 
  ggplot(aes(chars, n)) + 
    geom_col(color = "skyblue3", fill = "skyblue3") + 
    scale_x_continuous(breaks = seq(0, 300, 20)) + 
    labs(x = "characters", y = "count", title = "#blossom tweet length")
```

