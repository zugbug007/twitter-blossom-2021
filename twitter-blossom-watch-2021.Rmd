---
title: "National Trust Blossom Watch 2021"
author: "Alan Millington"
date: "`r Sys.time()`"
output:
  html_document: default
  pdf_document: 
    latex_engine: xelatex
  github_document: default
  word_document: default
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
Script.Name<-c("twitter-blossom-watch-2021.Rmd")

# ## install remotes package if it's not already
# if (!requireNamespace("remotes", quietly = TRUE)) {
#   install.packages("remotes")
# }

## install dev version of rtweet from github
#remotes::install_github("ropensci/rtweet")

## load rtweet package
library(rtweet)
library(rmarkdown)
library(tidyverse)
library(lubridate)
library(knitr)
library(purrr)
library(pander)
library(wordcloud)
library(tidytext)
library(igraph)
library(httpuv)
library(syuzhet)  # sentiment analysis
library(grid)
library(htmltools)
library(leaflet)

theme_set(theme_light())
```

```{r search-twitter, eval=FALSE, echo=FALSE}
## store api keys (these are fake example values; replace with your own keys)
#api_key <- Sys.getenv('TwitterAPIkey')
#api_secret_key <- Sys.getenv('TwitterAPIsecretkey')

# ## authenticate via web browser
# token <- create_token(
#   app = "rtwitterscraper_alanmillington",
#   consumer_key = api_key,
#   consumer_secret = api_secret_key, 
#   set_renv = FALSE)
```

```{r}
blossom2021 <- search_tweets("#blossom OR #blossomwatch OR #NationalTrust OR #EveryoneNeedsNature", n = 10000, lang = "en")

blossom2021_geo <- blossom2021 %>% mutate(geo_coords = gsub("\\)|c\\(", "", geo_coords),
         date_time = as.POSIXct(created_at, format = "%a %b %d %H:%M:%S +0000 %Y")) %>%
  separate(geo_coords, c("lat", "long"), sep = ", ") %>%
  mutate_at(c("lat", "long"), as.numeric)
```

This table shows the total count of hashtags used where the various combinations are used by twitter users.
When the tweet does not contain a hashtag, but contains the keywords it falls into the 'no hashtag' group.
If any new hashtags are required to be tracked, please let me know and this can be easily updated.

```{r count-hashtags}
hashtag_count <- tibble(hashtag = c("blossom", "blossomwatch", "NationalTrust + BlossomWatch", "EveryoneNeedsNature", "No Hashtag (Text contains keywords)"),
                        count = c(blossom2021 %>% 
                                    filter(grepl("blossom", hashtags, ignore.case = TRUE)) %>%
                                    filter(!grepl("blossomwatch", hashtags, ignore.case = TRUE)) %>%
                                    nrow(),
                                  blossom2021 %>% 
                                    filter(grepl("blossomwatch", hashtags, ignore.case = TRUE)) %>%
                                    nrow(),
                                  blossom2021 %>% 
                                    filter(grepl("NationalTrust", hashtags, ignore.case = TRUE)) %>%
                                    filter(grepl("blossomwatch", hashtags, ignore.case = TRUE)) %>%
                                    nrow(),
                                  blossom2021 %>% 
                                    filter(grepl("EveryoneNeedsNature", hashtags, ignore.case = TRUE)) %>%
                                    nrow(),
                                  blossom2021 %>% 
                                    filter(!grepl("blossom", hashtags, ignore.case = TRUE)) %>%
                                    filter(!grepl("blossomwatch", hashtags, ignore.case = TRUE)) %>%
                                    filter(!grepl("NationalTrust", hashtags, ignore.case = TRUE)) %>%
                                    filter(!grepl("EveryoneNeedsNature", hashtags, ignore.case = TRUE)) %>%
                                    nrow()))

hashtag_count %>%
  pander(justify = c("left", "right"))
```



# Timeline
## Tweets by day
Frequency of tweets broken down by day.
```{r tweets-by-day}
blossom2021 %>% 
  mutate(date = as_date(created_at, tz = "Europe/London")) %>% 
  count(date) %>% 
  ggplot(aes(date, n)) + geom_col(fill = "skyblue3") +  
    labs(x = "Date", y = "Tweets", title = "#blossom tweets per day") + 
    theme(axis.text = element_text(size = 10), axis.title = element_text(size = 10))
```

## Tweets by day and time
Filtered for dates March, London time.
Tweet frequency broken down by day and hour of day.


```{r tweets-by-day-hour, fig.height=11, fig.width=9}
blossom2021 %>% 
  mutate(datetime = as_datetime(created_at, tz = "Europe/London"), hour = hour(datetime)) %>%
  group_by(date = as_date(datetime), hour) %>% 
  summarise(count = n()) %>% 
  filter(date >= as_date("2021-03-11"), date <= Sys.Date()) %>%
  ggplot(aes(hour, count)) + geom_col(fill = "skyblue3") + facet_grid(strftime(date, "%b %d") ~ .) + 
    labs(x = "Hour", y = "Tweets", title = "#blossom tweets by time of day") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 15))
```


# Users
## Top tweeters
Top twitter users that have tweeted more than 10 tweets containing the #blossom hashtag.
```{r tweets-top-users, fig.height=7, fig.width=9}
blossom2021 %>% 
  count(screen_name) %>% 
  filter(n >= 10) %>% 
  ggplot(aes(reorder(screen_name, n), n)) + geom_col(fill = "skyblue3") + coord_flip() + 
    labs(x = "Screen Name", y = "Tweets", title = "#blossom tweets by user", subtitle = "users with >= 10 tweets") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Sources
Breakdown of twitter source clients that have used the #blossom hashtag.
```{r tweets-top-sources}
blossom2021 %>% 
distinct(screen_name, source) %>%
  count(source) %>% 
  filter(n >= 25) %>%
  ggplot(aes(reorder(source, n), n)) + geom_col(fill = "skyblue3") + coord_flip() + 
    labs(x = "Source", y = "Tweets", title = "#blossom tweets by source", subtitle = "sources with >= 25 tweets") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Network Replies
The "replies network", composed from users who reply directly to one another where the hashtag or keyword of blossom was part of the message text. Complied on Friday 19th March.

![](images/repliesnetwork.png)


```{r reply-network}
blossom2021_replies <- blossom2021 %>% 
  filter(!is.na(reply_to_screen_name)) %>% 
  select(screen_name, reply_to_screen_name) %>% 
  graph.data.frame(directed = TRUE)

V(blossom2021_replies)$label <- V(blossom2021_replies)$name
V(blossom2021_replies)$id    <- V(blossom2021_replies)$name

write_graph(blossom2021_replies, file = "blossom2021_replies.graphml", format = "graphml")
```

## Network Mentions
The "mentions network" is where users mention other users in their tweets and those tweets contain a keyword such as blossom. The large network (mid-right) is the National Trust twitter account. The smaller networks are key influencers that have shared blossom tweets with their network which have subsequently shared it to their followers too.

```{r mentions-network}
blossom_mentions <- blossom2021 %>% 
  mutate(mentions_screen_name = sapply(mentions_screen_name, 
                           function(x) paste(x, collapse = " "))) %>%
  select(screen_name, mentions_screen_name) %>% 
  mutate(mentions_screen_name = strsplit(mentions_screen_name, " ")) %>% 
  unnest(mentions_screen_name) %>% 
  filter(mentions_screen_name != "NA") %>% 
  graph.data.frame()

V(blossom_mentions)$label <- V(blossom_mentions)$name
V(blossom_mentions)$id    <- V(blossom_mentions)$name

write_graph(blossom_mentions, file = "blossom_mentions.graphml", format = "graphml")

```

![](images/mentionsnetwork.png)

# Retweets

```{r is-retweet, eval=FALSE, include=FALSE}
blossom2021 %>% 
  count(is_retweet) %>% 
  ggplot(aes(is_retweet, n)) + geom_col(fill = "skyblue3") + 
    labs(x = "Is retweet", y = "Tweets", title = "#blossom tweets by retweet status") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```


```{r retweet-count, eval=FALSE, include=FALSE}
blossom2021 %>% 
  ggplot(aes(retweet_count)) + geom_histogram(bins = max(blossom2021$retweet_count), fill = "skyblue3") +
    labs(x = "Retweet count", y = "Tweets", title = "#blossom distribution of retweets per tweet") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Top retweets
Top re-tweeters and total re-tweet counts.
```{r most-retweeted}
blossom2021 %>% 
  filter(screen_name != 'missmayim') %>%
  filter(screen_name != 'KhushnumaKashm1') %>%
  filter(is.na(retweet_status_id)) %>% 
  select(screen_name, text, retweet_count) %>% 
  arrange(desc(retweet_count)) %>% 
  distinct() %>%
  slice(1:10) %>% 
  pander(justify = c("left", "left", "right"), split.table = Inf)
```

# Favourites
## Favourite proportion
How many times a tweet was saved a favourite that contained the blossom keywords.
```{r has-favorite}
blossom2021 %>% 
  mutate(has_favorite = ifelse(favorite_count > 0, TRUE, FALSE)) %>% 
  count(has_favorite) %>%
  ggplot(aes(has_favorite, n)) + geom_col(fill = "skyblue3") + 
    labs(x = "Has favorite", y = "Tweets", title = "#blossom tweets by favorited status") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```


```{r favorite-count, eval=FALSE, include=FALSE}
blossom2021 %>% 
  ggplot(aes(favorite_count)) + geom_histogram(bins = max(blossom2021$favorite_count), fill = "skyblue3") +
    labs(x = "Favorite count", y = "Tweets", title = "#blossom distribution of favorites per tweet") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Top favourites
```{r most-favorited}
blossom2021 %>% 
  filter(screen_name != 'missmayim') %>%
  filter(screen_name != 'KhushnumaKashm1') %>%
  select(screen_name, text, favorite_count) %>% 
  arrange(desc(favorite_count)) %>% 
  distinct() %>%
  slice(1:10) %>% 
  pander(justify = c("left", "left", "right"), split.table = Inf)
```

# Quotes

```{r is-quote, eval=FALSE, include=FALSE}
blossom2021 %>% 
  count(is_quote) %>% 
  ggplot(aes(is_quote, n)) + geom_col(fill = "skyblue3") + 
    labs(x = "Is quote", y = "Tweets", title = "#blossom tweets by quote status") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```


```{r quotes-count, eval=FALSE, include=FALSE}
blossom2021 %>% 
  filter(!is.na(quoted_status_id)) %>% 
  count(quoted_status_id) %>% 
  ggplot(aes(n)) + geom_histogram(bins = 10, fill = "skyblue3") +
    labs(x = "Quote count", y = "Tweets", title = "#blossom distribution of quotes per tweet") + 
    scale_x_continuous(limits = c(0, 10), breaks = seq(0, 10, 2)) + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Top quotes
```{r most-quoted}
blossom2021 %>% 
  filter(!is.na(quoted_status_id)) %>% 
  count(quoted_status_id) %>% 
  filter(n > 1) %>% 
  arrange(desc(n)) %>% 
  slice(1:10) %>% 
  inner_join(select(blossom2021, screen_name, quoted_status_id, is_retweet, text)) %>% 
  filter(is_retweet == FALSE) %>% 
  select(screen_name, text, quote_count = n) %>%
  distinct() %>%
  slice(1:10) %>%
  pander(justify = c("left", "left", "right"), split.table = Inf)
```


# Media

## Media count
Shows tweets where a piece of media was shared such as images or videos.
```{r has-media}
blossom2021 %>% 
  mutate(has_media = !is.na(media_url)) %>% 
  count(has_media) %>% 
  ggplot(aes(has_media, n)) + geom_col(fill = "skyblue3") + 
    labs(x = "Has media", y = "Tweets", title = "#blossom tweets by media status") + 
    theme(axis.text = element_text(size = 12), axis.title = element_text(size = 12))
```

## Top media
```{r liked-media}
blossom_media <- blossom2021 %>%
  filter(screen_name != 'missmayim') %>%
  filter(screen_name != 'KhushnumaKashm1') %>%
  filter(!is.na(media_url)) %>% 
  arrange(desc(favorite_count)) %>%
  filter(favorite_count > 0)

blossom_media %>%
  slice(1:10) %>% 
  select(screen_name, text, favorite_count) %>%
  pander(justify = c("left", "left", "right"), split.table = Inf)
```

### Most liked media image
![](`r blossom_media[1, "media_url"]`)



# Tweet text
The top 150 words used 3 or more times within tweet which contain keywords around blossom. 
Words removed: blossom, blossomwatch, nationaltrust, everyoneneedsnature.

```{r count-words, fig.height=7, fig.width=9}
data("stop_words")

blossom2021 %>% 
  filter(is_retweet == FALSE) %>%
  select(text) %>%
  unnest_tokens(word, text) %>% 
  select(word) %>% 
  filter(!word %in% c("blossom", "blossomwatch", "nationaltrust", "everyoneneedsnature", "https", "t.co", "amp"),
         !word %in% tolower(blossom2021$screen_name), 
         !grepl("^\\d+$", word)) %>% 
  anti_join(stop_words) %>% 
  count(word) %>% 
  with(wordcloud(word, n, max.words = 150, min.freq = 3, colors = brewer.pal(8, "Dark2")))
```

## Tweets by Tweet Length
```{r count-tweet-length, fig.height=7, fig.width=9}
blossom2021 %>% 
  mutate(chars = nchar(text)) %>% 
  count(chars) %>% 
  ggplot(aes(chars, n)) + 
    geom_col(color = "skyblue3", fill = "skyblue3") + 
    scale_x_continuous(breaks = seq(0, 300, 20)) + 
    labs(x = "characters", y = "count", title = "#blossom tweet length")
```

## Blossom Sentiment Analysis - Visualisation
This process analyses each word within the tweet and then categorises the tweet into one of 8 main categories and polarity. 
Each triangle in the plot is a tweet where one of the blossom keywords was found and the overall tweet was categorised.
Blossom related tweets show strong 'positive' and 'joy' correlations based on the language used by tweeters.
```{r sentiment-analysis, fig.height=7, fig.width=9}
sentiment <- blossom2021$text
sentiment_clean <- iconv(sentiment, 'UTF-8', 'ASCII')
sentiment_clean <- syuzhet::get_nrc_sentiment(sentiment_clean)
# subset rtweet data (for ease) and combine with sentiment data
subset_tweets <- cbind(
  blossom2021[, c("status_id", "favorite_count", "retweet_count")],
  sentiment_clean)
# transform data to long form (makes plotting easier)
subset_tweets_long <- reshape2::melt(subset_tweets,
    variable.name = "emotion",
    value.name = "sentiment",
    id.vars = c("status_id", "favorite_count", "retweet_count"))

ggplot(subset_tweets_long, aes(x = emotion, y = sentiment,
  fill = emotion)) + theme_minimal() +
  coord_cartesian(ylim = c(0, 7)) +
  geom_jitter(color = "#ffffff", shape = 25, size = 2, stroke = .2)  +#alpha removed (alpha = .9) due to slow processing
  coord_flip() + labs(y = "", x = "",
    title = "#Blossom tweet sentiment") +
  theme(legend.position = "none",
    text = element_text(size = 18),
    axis.text.x = element_blank())

```

```{r echo=FALSE, fig.height=12, fig.width=12, message=FALSE, warning=FALSE}
blossom2021 %>%
  mutate(bbox_coords = gsub("\\)|c\\(", "", bbox_coords)) %>%
  separate(bbox_coords, c("box1", "box2","box3","box4", "box5", "box6", "box7", "box8"), sep = ", ") %>%
  mutate_at(c("box1", "box2","box3","box4", "box5", "box6", "box7", "box8"), as.numeric) %>%
    mutate(bbx_long = (box1 + box2 + box3 + box4)/4) %>%
    mutate(bbx_lat = (box5 + box6 + box7 + box8)/4) %>%
  filter(!is.na(place_type)) %>%
  filter(!is.na(media_url)) %>%
  leaflet() %>% 
      setView(lat = 52.8781, lng = -2.8360, zoom = 6) %>%
      addTiles() %>%
          addProviderTiles(providers$Esri.WorldImagery) %>%
 	        #addCircleMarkers(lng = ~bbx_long, lat = ~bbx_lat, popup =  ~text, color = "#FF0000", radius = 3, stroke = TRUE, fillOpacity = 0.2)
      addMarkers(lng = ~bbx_long, lat = ~bbx_lat, popup = 
                   ~paste0("<center><img src='",media_url,"' width=80%; height=80%;></center><b>@", screen_name, "</b>: ",text,"<br>"),
                 )
```

