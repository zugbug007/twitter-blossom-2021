---
title: "Blossom Map"
author: "Alan Millington"
date: "24/03/2021"
output: html_document
---

```{r render-output-doc}
 # render("twitter-blossom-watch-2021.Rmd", output_file = 'twitter-blossom-watch-2021.html')
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE, include = FALSE)
#bbox_cord
#c(-0.170246, -0.034078, -0.034078, -0.170246, 51.564585, 51.564585, 51.6112184, 51.6112184)

ts <- blossom2021 %>% filter(!is.na(bbox_coords)) %>%
    select(bbox_coords)

#library(openxlsx)

#write.xlsx(blossom2021_geo,"test_bb_geo.xlsx")

```

## Geo-Location of #Blossom Tweets

```{r echo=FALSE, fig.height=12, fig.width=9, message=FALSE, warning=FALSE}
blossom2021 %>%
  mutate(bbox_coords = gsub("\\)|c\\(", "", bbox_coords)) %>%
  separate(bbox_coords, c("box1", "box2","box3","box4", "box5", "box6", "box7", "box8"), sep = ", ") %>%
  mutate_at(c("box1", "box2","box3","box4", "box5", "box6", "box7", "box8"), as.numeric) %>%
    mutate(bbx_long = (box1 + box2 + box3 + box4)/4) %>%
    mutate(bbx_lat = (box5 + box6 + box7 + box8)/4) %>%
  filter(!is.na(place_type)) %>%
  filter(!is.na(media_url)) %>%
  leaflet() %>% 
      setView(lat = 52.8781, lng = -2.8360, zoom = 6) %>%
      addTiles() %>%
          addProviderTiles(providers$Esri.WorldImagery) %>%
 	        addCircleMarkers(lng = ~bbx_long, lat = ~bbx_lat, popup =  ~text, color = "#FF0000", radius = 3, stroke = TRUE, fillOpacity = 0.2)
```

```{r}
# Get the list of files
#----------------------------#
folder <- "twitter-blossom-watch-2021_files\\figure-gfm"
fileList <- dir(folder, recursive=TRUE)  # grep through these, if you are not loading them all

# use platform appropriate separator
files <- paste(folder, fileList, sep=.Platform$file.sep)


# Load them in
#----------------------------#
# Method 1:
invisible(sapply(files, source, local=TRUE))

#-- OR --#

# Method 2:
sapply(files, function(f) eval(parse(text=f)))

```





```{r}
news <- function(term) {
  require(dplyr)
  require(xml2)
  require(rvest)
  require(urltools)
  
  #Last 30 days
  html_dat <- read_html(paste0("https://news.google.com/search?q=",term,"%20when%3A30d&hl=en-GB&gl=GB&ceid=GB%3Aen"))
  filename <- paste(term, Sys.Date(),".xlsx",sep="")

  dat <- data.frame(Link = html_dat %>%
                      html_nodes('.VDXfz') %>% 
                      html_attr('href')) %>% 
    mutate(Link = gsub("./articles/","https://news.google.com/articles/",Link))
  
  news_dat <- data.frame(
    Title = html_dat %>%
      html_nodes('.DY5T1d') %>% 
      html_text(),
    Link = dat$Link,
    Description =  html_dat %>%
      html_nodes('.Rai5ob') %>% 
      html_text()
  ) 
  
  # Extract Source and Time (To avoid missing content)
  prod <- html_nodes(html_dat, ".SVJrMe")
  Source <- lapply(prod, function(x) {
    norm <- tryCatch(html_node(x, "a") %>% html_text() ,
                     error=function(err) {NA})
  })
  
  time <- lapply(prod, function(x) {
    norm <- tryCatch(html_node(x, "time") %>% html_text(),
                     error=function(err) {NA})
  })
  
  mydf <- data.frame(Source = do.call(rbind, Source), Time = do.call(rbind, time), stringsAsFactors = F)
  dff <- cbind(news_dat, mydf) %>% distinct(Time, .keep_all = TRUE)
  search_term <- term
  return(dff)
}
# term need to be URL encoded for use in the URL structure. Decode and clean up for the filename useage
# re-encode for the parameter passing to the function
search_term <- URLdecode('national%20trust%20blossom')
blossom_news <- news(URLencode(search_term))
```

```{r bond-sentiment, eval=FALSE, fig.height=7, fig.width=9, include=FALSE}
bond_sentiment <- blossom2021 %>% 
  filter(screen_name !='bloomy_flowers') %>%
  filter(grepl('plastic|fake|bond|bond/ street|artificial|fail',text, ignore.case = TRUE)) %>%
  filter(is_retweet == FALSE)


sentiment <- bond_sentiment$text
sentiment_clean <- iconv(sentiment, 'UTF-8', 'ASCII')
sentiment_clean <- syuzhet::get_nrc_sentiment(sentiment_clean)
# subset rtweet data (for ease) and combine with sentiment data
subset_tweets <- cbind(
  bond_sentiment[, c("status_id", "favorite_count", "retweet_count")],
  sentiment_clean)
# transform data to long form (makes plotting easier)
subset_tweets_long <- reshape2::melt(subset_tweets,
    variable.name = "emotion",
    value.name = "sentiment",
    id.vars = c("status_id", "favorite_count", "retweet_count"))

ggplot(subset_tweets_long, aes(x = emotion, y = sentiment,
  fill = emotion)) + theme_minimal() +
  coord_cartesian(ylim = c(0, 7)) +
  geom_jitter(color = "#ffffff", shape = 25, size = 2, stroke = .2)  +#alpha removed (alpha = .9) due to slow processing
  coord_flip() + labs(y = "", x = "",
    title = "#Blossom tweet sentiment") +
  theme(legend.position = "none",
    text = element_text(size = 18),
    axis.text.x = element_blank())
```


```{r bond-sentiment, eval=FALSE, fig.height=7, fig.width=9, include=FALSE}
blossom_icon <- makeIcon(
  iconUrl = "http://alanmillington.com/blossom/images/oakleaf.png",
  iconWidth = 37, iconHeight = 51,
  iconAnchorX = 0, iconAnchorY = 0,
  shadowUrl = "http://alanmillington.com/blossom/images/marker-shadow.png",
  shadowWidth = 51, shadowHeight = 41,
  shadowAnchorX = 13, shadowAnchorY = 15
)

bond_sentiment %>%
  mutate(bbox_coords = gsub("\\)|c\\(", "", bbox_coords)) %>%
  separate(bbox_coords, c("box1", "box2","box3","box4", "box5", "box6", "box7", "box8"), sep = ", ") %>%
  mutate_at(c("box1", "box2","box3","box4", "box5", "box6", "box7", "box8"), as.numeric) %>%
    mutate(bbx_long = (box1 + box2 + box3 + box4)/4) %>%
    mutate(bbx_lat = (box5 + box6 + box7 + box8)/4) %>%
  filter(!is.na(place_type)) %>%
  filter(!is.na(media_url)) %>%
  #count()
  leaflet() %>% 
      setView(lat = 52.8781, lng = -2.8360, zoom = 6) %>%
      addTiles() %>%
          addProviderTiles(providers$Esri.WorldImagery) %>%
      addMarkers(lng = ~bbx_long, lat = ~bbx_lat, popup = 
                   ~paste0("<center><img src='",media_url,"' width=80%; height=80%;></center><b>@", screen_name, "</b>: ",text,"<br>"), icon = blossom_icon,
                 )


```


```{r}
title: "<img src='www/binary-logo.jpg' width='240'>"
subtitle: "[<span style='color:blue'>binary.com</span>](https://github.com/englianhu/binary.com-interview-question) Interview Question I"
author: "[<span style='color:blue'>®γσ, Lian Hu</span>](https://englianhu.github.io/) <img src='www/ENG.jpg' width='24'> <img src='www/RYO.jpg' width='24'>白戸則道®"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html:
    toc: yes
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
link-citations: yes
```

